#!/usr/bin/env ruby

require "bundler/setup"
require_relative "../lib/decision_agent"
require_relative "../lib/decision_agent/web/server"

def print_help
  puts <<~HELP
    DecisionAgent CLI

    Usage:
      decision_agent [command] [options]

    Commands:
      web [PORT]         Start the web UI rule builder (default port: 4567)
      validate FILE      Validate a rules JSON file
      version            Show version
      help               Show this help message

    Examples:
      decision_agent web               # Start web UI on port 4567
      decision_agent web 8080          # Start web UI on port 8080
      decision_agent validate rules.json
      decision_agent version

    For more information, visit:
    https://github.com/samaswin87/decision_agent
  HELP
end

def start_web_ui(port = 4567)
  # Ruby 4.0 compatibility: Puma expects Bundler::ORIGINAL_ENV which was removed
  if defined?(Bundler) && !Bundler.const_defined?(:ORIGINAL_ENV)
    Bundler.const_set(:ORIGINAL_ENV, ENV.to_h.dup)
  end

  puts "üéØ Starting DecisionAgent Rule Builder..."
  puts "üìç Server: http://localhost:#{port}"
  puts "‚ö°Ô∏è Press Ctrl+C to stop"
  puts ""

  DecisionAgent::Web::Server.start!(port: port)
end

def validate_file(filepath)
  unless File.exist?(filepath)
    puts "‚ùå Error: File not found: #{filepath}"
    exit 1
  end

  begin
    puts "üîç Validating #{filepath}..."

    json_content = File.read(filepath)
    data = JSON.parse(json_content)

    DecisionAgent::Dsl::SchemaValidator.validate!(data)

    puts "‚úÖ Validation successful!"
    puts "   Version: #{data['version'] || data[:version]}"
    puts "   Ruleset: #{data['ruleset'] || data[:ruleset]}"
    puts "   Rules: #{data['rules']&.size || 0}"

  rescue JSON::ParserError => e
    puts "‚ùå JSON Parsing Error:"
    puts "   #{e.message}"
    exit 1

  rescue DecisionAgent::InvalidRuleDslError => e
    puts "‚ùå Validation Failed:"
    puts ""
    puts e.message
    exit 1

  rescue => e
    puts "‚ùå Unexpected Error:"
    puts "   #{e.message}"
    exit 1
  end
end

# Main CLI handler
command = ARGV[0] || "help"

case command
when "web"
  port = ARGV[1] ? ARGV[1].to_i : 4567
  start_web_ui(port)

when "validate"
  if ARGV[1].nil?
    puts "‚ùå Error: Please provide a file path"
    puts "Usage: decision_agent validate FILE"
    exit 1
  end
  validate_file(ARGV[1])

when "version"
  puts "DecisionAgent version #{DecisionAgent::VERSION}"

when "help", "-h", "--help"
  print_help

else
  puts "‚ùå Unknown command: #{command}"
  puts ""
  print_help
  exit 1
end
