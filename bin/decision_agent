#!/usr/bin/env ruby

require "bundler/setup"
require_relative "../lib/decision_agent"
require_relative "../lib/decision_agent/web/server"
require_relative "../lib/decision_agent/dmn/importer"
require_relative "../lib/decision_agent/dmn/exporter"

def print_help
  puts <<~HELP
    DecisionAgent CLI

    Usage:
      decision_agent [command] [options]

    Commands:
      web [PORT]         Start the web UI rule builder (default port: 4567)
      validate FILE      Validate a rules JSON file
      dmn import FILE    Import a DMN XML file
      dmn export RULESET OUTPUT  Export a ruleset to DMN XML
      version            Show version
      help               Show this help message

    Examples:
      decision_agent web               # Start web UI on port 4567
      decision_agent web 8080          # Start web UI on port 8080
      decision_agent validate rules.json
      decision_agent dmn import loan_decision.dmn
      decision_agent dmn export loan_rules loan_export.dmn
      decision_agent version

    For more information, visit:
    https://github.com/samaswin/decision_agent
  HELP
end

def start_web_ui(port = 4567)
  # Ruby 4.0 compatibility: Puma expects Bundler::ORIGINAL_ENV which was removed
  Bundler.const_set(:ORIGINAL_ENV, ENV.to_h.dup) if defined?(Bundler) && !Bundler.const_defined?(:ORIGINAL_ENV)

  puts "üéØ Starting DecisionAgent Rule Builder..."
  puts "üìç Server: http://localhost:#{port}"
  puts "‚ö°Ô∏è Press Ctrl+C to stop"
  puts ""

  DecisionAgent::Web::Server.start!(port: port)
end

def validate_file(filepath)
  unless File.exist?(filepath)
    puts "‚ùå Error: File not found: #{filepath}"
    exit 1
  end

  begin
    puts "üîç Validating #{filepath}..."

    json_content = File.read(filepath)
    data = JSON.parse(json_content)

    DecisionAgent::Dsl::SchemaValidator.validate!(data)

    puts "‚úÖ Validation successful!"
    puts "   Version: #{data['version'] || data[:version]}"
    puts "   Ruleset: #{data['ruleset'] || data[:ruleset]}"
    puts "   Rules: #{data['rules']&.size || 0}"
  rescue JSON::ParserError => e
    puts "‚ùå JSON Parsing Error:"
    puts "   #{e.message}"
    exit 1
  rescue DecisionAgent::InvalidRuleDslError => e
    puts "‚ùå Validation Failed:"
    puts ""
    puts e.message
    exit 1
  rescue StandardError => e
    puts "‚ùå Unexpected Error:"
    puts "   #{e.message}"
    exit 1
  end
end

def dmn_import(filepath, ruleset_name: nil)
  unless File.exist?(filepath)
    puts "‚ùå Error: File not found: #{filepath}"
    exit 1
  end

  begin
    puts "üì• Importing DMN file: #{filepath}..."

    importer = DecisionAgent::Dmn::Importer.new
    result = importer.import(
      filepath,
      ruleset_name: ruleset_name,
      created_by: ENV["USER"] || "cli_user"
    )

    puts "‚úÖ Import successful!"
    puts "   Model: #{result[:model].name}"
    puts "   Decisions imported: #{result[:decisions_imported]}"
    puts "   Namespace: #{result[:model].namespace}"

    result[:model].decisions.each do |decision|
      puts "   - Decision: #{decision.name} (#{decision.id})"
      if decision.decision_table
        puts "     Rules: #{decision.decision_table.rules.size}"
        puts "     Hit Policy: #{decision.decision_table.hit_policy}"
      end
    end

    if result[:versions].any?
      puts ""
      puts "   Versions created:"
      result[:versions].each do |version|
        puts "   - #{version[:rule_id]}: version #{version[:version]}"
      end
    end
  rescue DecisionAgent::Dmn::InvalidDmnModelError, DecisionAgent::Dmn::DmnParseError => e
    puts "‚ùå DMN Import Error:"
    puts "   #{e.message}"
    exit 1
  rescue StandardError => e
    puts "‚ùå Unexpected Error:"
    puts "   #{e.message}"
    puts "   #{e.backtrace.first}" if ENV["DEBUG"]
    exit 1
  end
end

def dmn_export(ruleset_id, output_path)
  begin
    puts "üì§ Exporting ruleset: #{ruleset_id}..."

    exporter = DecisionAgent::Dmn::Exporter.new
    dmn_xml = exporter.export(ruleset_id, output_path: output_path)

    puts "‚úÖ Export successful!"
    puts "   Ruleset: #{ruleset_id}"
    puts "   Output: #{output_path}"
    puts "   Size: #{dmn_xml.bytesize} bytes"
  rescue DecisionAgent::Dmn::InvalidDmnModelError => e
    puts "‚ùå Export Error:"
    puts "   #{e.message}"
    exit 1
  rescue StandardError => e
    puts "‚ùå Unexpected Error:"
    puts "   #{e.message}"
    puts "   #{e.backtrace.first}" if ENV["DEBUG"]
    exit 1
  end
end

# Main CLI handler
command = ARGV[0] || "help"

case command
when "web"
  port = ARGV[1] ? ARGV[1].to_i : 4567
  start_web_ui(port)

when "validate"
  if ARGV[1].nil?
    puts "‚ùå Error: Please provide a file path"
    puts "Usage: decision_agent validate FILE"
    exit 1
  end
  validate_file(ARGV[1])

when "dmn"
  subcommand = ARGV[1]
  case subcommand
  when "import"
    if ARGV[2].nil?
      puts "‚ùå Error: Please provide a DMN file path"
      puts "Usage: decision_agent dmn import <file.xml>"
      exit 1
    end
    ruleset_name = ARGV[3] # Optional ruleset name
    dmn_import(ARGV[2], ruleset_name: ruleset_name)

  when "export"
    if ARGV[2].nil? || ARGV[3].nil?
      puts "‚ùå Error: Please provide ruleset ID and output file path"
      puts "Usage: decision_agent dmn export <ruleset> <output.xml>"
      exit 1
    end
    dmn_export(ARGV[2], ARGV[3])

  else
    puts "‚ùå Unknown DMN subcommand: #{subcommand || '(none)'}"
    puts ""
    puts "DMN Commands:"
    puts "  import FILE     Import a DMN XML file"
    puts "  export RULESET OUTPUT  Export a ruleset to DMN XML"
    exit 1
  end

when "version"
  puts "DecisionAgent version #{DecisionAgent::VERSION}"

when "help", "-h", "--help"
  print_help

else
  puts "‚ùå Unknown command: #{command}"
  puts ""
  print_help
  exit 1
end
