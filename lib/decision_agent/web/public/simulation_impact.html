<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impact Analysis</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .simulation-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .step-section {
            background: var(--panel-bg);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .metric-card {
            background: var(--hover-bg);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .metric-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .risk-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .risk-low {
            background: #d1fae5;
            color: #065f46;
        }

        .risk-medium {
            background: #fef3c7;
            color: #92400e;
        }

        .risk-high {
            background: #fed7aa;
            color: #9a3412;
        }

        .risk-critical {
            background: #fee2e2;
            color: #991b1b;
        }

        .hidden {
            display: none;
        }

        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
        }

        .success-message {
            background: #d1fae5;
            color: #065f46;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
        }

        .header-links {
            margin-top: 20px;
        }

        .header-links a {
            margin-right: 15px;
            text-decoration: none;
            color: var(--primary-color);
        }

        .file-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload-area:hover {
            border-color: var(--primary-color);
            background: var(--hover-bg);
        }
    </style>
</head>
<body>
    <div class="simulation-container">
        <header>
            <h1>üìä Impact Analysis</h1>
            <p class="subtitle">Quantify the impact of rule changes before deploying to production</p>
            <div class="header-links">
                <a href="/simulation">‚Üê Back to Simulation Dashboard</a>
            </div>
        </header>

        <!-- Step 1: Select Versions -->
        <div class="step-section">
            <h2>Select Versions to Compare</h2>
            
            <div class="form-group">
                <label for="baselineVersion">Baseline Version:</label>
                <select id="baselineVersion" class="input">
                    <option value="">-- Select Baseline Version --</option>
                </select>
            </div>

            <div class="form-group">
                <label for="proposedVersion">Proposed Version:</label>
                <select id="proposedVersion" class="input">
                    <option value="">-- Select Proposed Version --</option>
                </select>
            </div>
        </div>

        <!-- Step 2: Upload Test Data -->
        <div class="step-section">
            <h2>Upload Test Data</h2>
            <p>Upload a CSV or JSON file with test contexts, or paste JSON directly</p>
            
            <div class="file-upload-area" id="uploadArea">
                <p>üìÅ Drag and drop your CSV/JSON file here, or click to browse</p>
                <input type="file" id="fileInput" accept=".csv,.json" style="display: none;">
            </div>

            <div class="form-group" style="margin-top: 20px;">
                <label for="testDataJson">Or paste test data JSON:</label>
                <textarea id="testDataJson" class="input" rows="5" placeholder='[{"credit_score": 650, "amount": 100000}, ...]'></textarea>
            </div>

            <div id="uploadStatus" class="hidden"></div>
        </div>

        <!-- Step 3: Run Analysis -->
        <div class="step-section">
            <h2>Run Impact Analysis</h2>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" id="calculateRisk" checked> Calculate risk score
                </label>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="parallelExecution" checked> Parallel execution
                </label>
            </div>
            <div class="form-group">
                <label for="threadCount">Thread count:</label>
                <input type="number" id="threadCount" value="4" min="1" max="16" class="input" style="width: 100px;">
            </div>

            <button class="btn btn-primary" id="runAnalysisBtn" disabled>‚ñ∂ Run Impact Analysis</button>

            <div id="runStatus" class="hidden"></div>
        </div>

        <!-- Step 4: Results -->
        <div class="step-section" id="resultsSection" style="display: none;">
            <h2>Impact Analysis Results</h2>

            <!-- Risk Score -->
            <div id="riskSection" class="hidden">
                <h3>Risk Assessment</h3>
                <div style="margin: 20px 0;">
                    <div style="font-size: 1.5rem; margin-bottom: 10px;">Risk Level: <span id="riskLevel" class="risk-badge"></span></div>
                    <div style="font-size: 1.2rem;">Risk Score: <span id="riskScore"></span></div>
                </div>
            </div>

            <!-- Statistics -->
            <div id="statisticsSection" class="hidden">
                <h3>Impact Statistics</h3>
                <div class="metrics-grid" id="statisticsGrid"></div>
            </div>

            <!-- Decision Distribution -->
            <div id="distributionSection" class="hidden">
                <h3>Decision Distribution Changes</h3>
                <div id="distributionContent"></div>
            </div>

            <!-- Confidence Impact -->
            <div id="confidenceSection" class="hidden">
                <h3>Confidence Impact</h3>
                <div id="confidenceContent"></div>
            </div>
        </div>
    </div>

    <script>
        function getBasePath() {
            const baseTag = document.querySelector('base');
            if (baseTag && baseTag.href) {
                try {
                    const baseUrl = new URL(baseTag.href, window.location.href);
                    let path = baseUrl.pathname;
                    if (path && !path.endsWith('/')) path += '/';
                    return path;
                } catch (e) {
                    if (baseTag.href.startsWith('/')) {
                        const match = baseTag.href.match(/^(https?:\/\/[^\/]+)?(\/.*?)\/?$/);
                        if (match && match[2]) {
                            return match[2].endsWith('/') ? match[2] : match[2] + '/';
                        }
                    }
                }
            }
            const pathname = window.location.pathname;
            if (pathname.includes('/decision_agent')) {
                const match = pathname.match(/^(\/.*?\/decision_agent)\/?/);
                if (match) {
                    return match[1].endsWith('/') ? match[1] : match[1] + '/';
                }
            }
            return pathname.substring(0, pathname.lastIndexOf('/') + 1) || '/';
        }

        const basePath = getBasePath();
        let testData = null;

        // Load versions
        function loadVersions() {
            fetch(`${basePath}api/versions`)
                .then(response => response.json())
                .then(data => {
                    const baselineSelect = document.getElementById('baselineVersion');
                    const proposedSelect = document.getElementById('proposedVersion');
                    
                    baselineSelect.innerHTML = '<option value="">-- Select Baseline Version --</option>';
                    proposedSelect.innerHTML = '<option value="">-- Select Proposed Version --</option>';
                    
                    if (data.versions) {
                        data.versions.forEach(v => {
                            const option1 = document.createElement('option');
                            option1.value = v.id;
                            option1.textContent = `${v.rule_id} v${v.version_number} (${v.status})`;
                            baselineSelect.appendChild(option1);
                            
                            const option2 = document.createElement('option');
                            option2.value = v.id;
                            option2.textContent = `${v.rule_id} v${v.version_number} (${v.status})`;
                            proposedSelect.appendChild(option2);
                        });
                    }
                })
                .catch(error => console.error('Error loading versions:', error));
        }

        loadVersions();

        // File upload
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadStatus = document.getElementById('uploadStatus');

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files[0]);
            }
        });

        function handleFileUpload(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    if (file.name.endsWith('.json')) {
                        testData = JSON.parse(e.target.result);
                    } else if (file.name.endsWith('.csv')) {
                        const lines = e.target.result.split('\n');
                        const headers = lines[0].split(',');
                        testData = lines.slice(1).filter(l => l.trim()).map(line => {
                            const values = line.split(',');
                            const obj = {};
                            headers.forEach((h, i) => {
                                obj[h.trim()] = values[i]?.trim() || '';
                            });
                            return obj;
                        });
                    }
                    
                    uploadStatus.className = 'success-message';
                    uploadStatus.textContent = `Successfully loaded ${testData.length} test contexts`;
                    uploadStatus.classList.remove('hidden');
                    checkReady();
                } catch (error) {
                    uploadStatus.className = 'error-message';
                    uploadStatus.textContent = `Error: ${error.message}`;
                    uploadStatus.classList.remove('hidden');
                }
            };
            reader.readAsText(file);
        }

        // Test data JSON input
        document.getElementById('testDataJson').addEventListener('input', (e) => {
            try {
                if (e.target.value.trim()) {
                    testData = JSON.parse(e.target.value);
                    uploadStatus.className = 'success-message';
                    uploadStatus.textContent = `Loaded ${testData.length} test contexts from JSON`;
                    uploadStatus.classList.remove('hidden');
                } else {
                    testData = null;
                    uploadStatus.classList.add('hidden');
                }
                checkReady();
            } catch (error) {
                testData = null;
                uploadStatus.className = 'error-message';
                uploadStatus.textContent = `Invalid JSON: ${error.message}`;
                uploadStatus.classList.remove('hidden');
            }
        });

        function checkReady() {
            const baseline = document.getElementById('baselineVersion').value;
            const proposed = document.getElementById('proposedVersion').value;
            document.getElementById('runAnalysisBtn').disabled = !(baseline && proposed && testData);
        }

        document.getElementById('baselineVersion').addEventListener('change', checkReady);
        document.getElementById('proposedVersion').addEventListener('change', checkReady);

        // Run analysis
        document.getElementById('runAnalysisBtn').addEventListener('click', () => {
            const baselineVersion = document.getElementById('baselineVersion').value;
            const proposedVersion = document.getElementById('proposedVersion').value;

            if (!baselineVersion || !proposedVersion || !testData) {
                alert('Please select both versions and provide test data');
                return;
            }

            const runStatus = document.getElementById('runStatus');
            runStatus.className = 'hidden';

            const requestData = {
                baseline_version: baselineVersion,
                proposed_version: proposedVersion,
                test_data: testData,
                options: {
                    calculate_risk: document.getElementById('calculateRisk').checked,
                    parallel: document.getElementById('parallelExecution').checked,
                    thread_count: parseInt(document.getElementById('threadCount').value) || 4
                }
            };

            fetch(`${basePath}api/simulation/impact`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    runStatus.className = 'error-message';
                    runStatus.textContent = `Error: ${data.error}`;
                    runStatus.classList.remove('hidden');
                } else {
                    runStatus.className = 'success-message';
                    runStatus.textContent = 'Impact analysis completed successfully!';
                    runStatus.classList.remove('hidden');
                    displayResults(data);
                }
            })
            .catch(error => {
                runStatus.className = 'error-message';
                runStatus.textContent = `Error: ${error.message}`;
                runStatus.classList.remove('hidden');
            });
        });

        function displayResults(data) {
            document.getElementById('resultsSection').style.display = 'block';
            const results = data.results;

            // Risk assessment
            if (results.risk_score !== undefined) {
                const riskLevel = document.getElementById('riskLevel');
                const riskScore = document.getElementById('riskScore');
                riskScore.textContent = results.risk_score.toFixed(3);
                
                const level = results.risk_level || 'low';
                riskLevel.textContent = level.toUpperCase();
                riskLevel.className = 'risk-badge risk-' + level;
                
                document.getElementById('riskSection').classList.remove('hidden');
            }

            // Statistics
            if (results.decision_changes !== undefined) {
                const statsGrid = document.getElementById('statisticsGrid');
                statsGrid.innerHTML = `
                    <div class="metric-card">
                        <div class="metric-value">${results.decision_changes}</div>
                        <div class="metric-label">Decision Changes</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${(results.change_rate * 100).toFixed(2)}%</div>
                        <div class="metric-label">Change Rate</div>
                    </div>
                `;
                document.getElementById('statisticsSection').classList.remove('hidden');
            }

            // Decision distribution
            if (results.decision_distribution) {
                const distContent = document.getElementById('distributionContent');
                let html = '<h4>Baseline:</h4><pre>' + JSON.stringify(results.decision_distribution.baseline, null, 2) + '</pre>';
                html += '<h4>Proposed:</h4><pre>' + JSON.stringify(results.decision_distribution.proposed, null, 2) + '</pre>';
                distContent.innerHTML = html;
                document.getElementById('distributionSection').classList.remove('hidden');
            }

            // Confidence impact
            if (results.confidence_impact) {
                const confContent = document.getElementById('confidenceContent');
                let html = '<pre>' + JSON.stringify(results.confidence_impact, null, 2) + '</pre>';
                confContent.innerHTML = html;
                document.getElementById('confidenceSection').classList.remove('hidden');
            }
        }
    </script>
</body>
</html>

